var __create=Object.create;var{getPrototypeOf:__getProtoOf,defineProperty:__defProp,getOwnPropertyNames:__getOwnPropNames,getOwnPropertyDescriptor:__getOwnPropDesc}=Object,__hasOwnProp=Object.prototype.hasOwnProperty;var __toESM=(mod,isNodeMode,target)=>{target=mod!=null?__create(__getProtoOf(mod)):{};let to=isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target;for(let key of __getOwnPropNames(mod))if(!__hasOwnProp.call(to,key))__defProp(to,key,{get:()=>mod[key],enumerable:!0});return to},__moduleCache=new WeakMap,__toCommonJS=(from)=>{var entry=__moduleCache.get(from),desc;if(entry)return entry;if(entry=__defProp({},"__esModule",{value:!0}),from&&typeof from==="object"||typeof from==="function")__getOwnPropNames(from).map((key)=>!__hasOwnProp.call(entry,key)&&__defProp(entry,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable}));return __moduleCache.set(from,entry),entry},__commonJS=(cb,mod)=>()=>(mod||cb((mod={exports:{}}).exports,mod),mod.exports);var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0,configurable:!0,set:(newValue)=>all[name]=()=>newValue})};var __esm=(fn,res)=>()=>(fn&&(res=fn(fn=0)),res);var __require=((x)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b)=>(typeof require!=="undefined"?require:a)[b]}):x)(function(x){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+x+'" is not supported')});var exports_path={};__export(exports_path,{sep:()=>sep,resolve:()=>resolve,relative:()=>relative,posix:()=>posix,parse:()=>parse,normalize:()=>normalize,join:()=>join,isAbsolute:()=>isAbsolute,format:()=>format,extname:()=>extname,dirname:()=>dirname,delimiter:()=>delimiter,default:()=>path_default,basename:()=>basename,_makeLong:()=>_makeLong});function assertPath(path){if(typeof path!=="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(path))}function normalizeStringPosix(path,allowAboveRoot){var res="",lastSegmentLength=0,lastSlash=-1,dots=0,code;for(var i=0;i<=path.length;++i){if(i<path.length)code=path.charCodeAt(i);else if(code===47)break;else code=47;if(code===47){if(lastSlash===i-1||dots===1);else if(lastSlash!==i-1&&dots===2){if(res.length<2||lastSegmentLength!==2||res.charCodeAt(res.length-1)!==46||res.charCodeAt(res.length-2)!==46){if(res.length>2){var lastSlashIndex=res.lastIndexOf("/");if(lastSlashIndex!==res.length-1){if(lastSlashIndex===-1)res="",lastSegmentLength=0;else res=res.slice(0,lastSlashIndex),lastSegmentLength=res.length-1-res.lastIndexOf("/");lastSlash=i,dots=0;continue}}else if(res.length===2||res.length===1){res="",lastSegmentLength=0,lastSlash=i,dots=0;continue}}if(allowAboveRoot){if(res.length>0)res+="/..";else res="..";lastSegmentLength=2}}else{if(res.length>0)res+="/"+path.slice(lastSlash+1,i);else res=path.slice(lastSlash+1,i);lastSegmentLength=i-lastSlash-1}lastSlash=i,dots=0}else if(code===46&&dots!==-1)++dots;else dots=-1}return res}function _format(sep,pathObject){var dir=pathObject.dir||pathObject.root,base=pathObject.base||(pathObject.name||"")+(pathObject.ext||"");if(!dir)return base;if(dir===pathObject.root)return dir+base;return dir+sep+base}function resolve(){var resolvedPath="",resolvedAbsolute=!1,cwd;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path;if(i>=0)path=arguments[i];else{if(cwd===void 0)cwd=process.cwd();path=cwd}if(assertPath(path),path.length===0)continue;resolvedPath=path+"/"+resolvedPath,resolvedAbsolute=path.charCodeAt(0)===47}if(resolvedPath=normalizeStringPosix(resolvedPath,!resolvedAbsolute),resolvedAbsolute)if(resolvedPath.length>0)return"/"+resolvedPath;else return"/";else if(resolvedPath.length>0)return resolvedPath;else return"."}function normalize(path){if(assertPath(path),path.length===0)return".";var isAbsolute=path.charCodeAt(0)===47,trailingSeparator=path.charCodeAt(path.length-1)===47;if(path=normalizeStringPosix(path,!isAbsolute),path.length===0&&!isAbsolute)path=".";if(path.length>0&&trailingSeparator)path+="/";if(isAbsolute)return"/"+path;return path}function isAbsolute(path){return assertPath(path),path.length>0&&path.charCodeAt(0)===47}function join(){if(arguments.length===0)return".";var joined;for(var i=0;i<arguments.length;++i){var arg=arguments[i];if(assertPath(arg),arg.length>0)if(joined===void 0)joined=arg;else joined+="/"+arg}if(joined===void 0)return".";return normalize(joined)}function relative(from,to){if(assertPath(from),assertPath(to),from===to)return"";if(from=resolve(from),to=resolve(to),from===to)return"";var fromStart=1;for(;fromStart<from.length;++fromStart)if(from.charCodeAt(fromStart)!==47)break;var fromEnd=from.length,fromLen=fromEnd-fromStart,toStart=1;for(;toStart<to.length;++toStart)if(to.charCodeAt(toStart)!==47)break;var toEnd=to.length,toLen=toEnd-toStart,length=fromLen<toLen?fromLen:toLen,lastCommonSep=-1,i=0;for(;i<=length;++i){if(i===length){if(toLen>length){if(to.charCodeAt(toStart+i)===47)return to.slice(toStart+i+1);else if(i===0)return to.slice(toStart+i)}else if(fromLen>length){if(from.charCodeAt(fromStart+i)===47)lastCommonSep=i;else if(i===0)lastCommonSep=0}break}var fromCode=from.charCodeAt(fromStart+i),toCode=to.charCodeAt(toStart+i);if(fromCode!==toCode)break;else if(fromCode===47)lastCommonSep=i}var out="";for(i=fromStart+lastCommonSep+1;i<=fromEnd;++i)if(i===fromEnd||from.charCodeAt(i)===47)if(out.length===0)out+="..";else out+="/..";if(out.length>0)return out+to.slice(toStart+lastCommonSep);else{if(toStart+=lastCommonSep,to.charCodeAt(toStart)===47)++toStart;return to.slice(toStart)}}function _makeLong(path){return path}function dirname(path){if(assertPath(path),path.length===0)return".";var code=path.charCodeAt(0),hasRoot=code===47,end=-1,matchedSlash=!0;for(var i=path.length-1;i>=1;--i)if(code=path.charCodeAt(i),code===47){if(!matchedSlash){end=i;break}}else matchedSlash=!1;if(end===-1)return hasRoot?"/":".";if(hasRoot&&end===1)return"//";return path.slice(0,end)}function basename(path,ext){if(ext!==void 0&&typeof ext!=="string")throw new TypeError('"ext" argument must be a string');assertPath(path);var start=0,end=-1,matchedSlash=!0,i;if(ext!==void 0&&ext.length>0&&ext.length<=path.length){if(ext.length===path.length&&ext===path)return"";var extIdx=ext.length-1,firstNonSlashEnd=-1;for(i=path.length-1;i>=0;--i){var code=path.charCodeAt(i);if(code===47){if(!matchedSlash){start=i+1;break}}else{if(firstNonSlashEnd===-1)matchedSlash=!1,firstNonSlashEnd=i+1;if(extIdx>=0)if(code===ext.charCodeAt(extIdx)){if(--extIdx===-1)end=i}else extIdx=-1,end=firstNonSlashEnd}}if(start===end)end=firstNonSlashEnd;else if(end===-1)end=path.length;return path.slice(start,end)}else{for(i=path.length-1;i>=0;--i)if(path.charCodeAt(i)===47){if(!matchedSlash){start=i+1;break}}else if(end===-1)matchedSlash=!1,end=i+1;if(end===-1)return"";return path.slice(start,end)}}function extname(path){assertPath(path);var startDot=-1,startPart=0,end=-1,matchedSlash=!0,preDotState=0;for(var i=path.length-1;i>=0;--i){var code=path.charCodeAt(i);if(code===47){if(!matchedSlash){startPart=i+1;break}continue}if(end===-1)matchedSlash=!1,end=i+1;if(code===46){if(startDot===-1)startDot=i;else if(preDotState!==1)preDotState=1}else if(startDot!==-1)preDotState=-1}if(startDot===-1||end===-1||preDotState===0||preDotState===1&&startDot===end-1&&startDot===startPart+1)return"";return path.slice(startDot,end)}function format(pathObject){if(pathObject===null||typeof pathObject!=="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof pathObject);return _format("/",pathObject)}function parse(path){assertPath(path);var ret={root:"",dir:"",base:"",ext:"",name:""};if(path.length===0)return ret;var code=path.charCodeAt(0),isAbsolute2=code===47,start;if(isAbsolute2)ret.root="/",start=1;else start=0;var startDot=-1,startPart=0,end=-1,matchedSlash=!0,i=path.length-1,preDotState=0;for(;i>=start;--i){if(code=path.charCodeAt(i),code===47){if(!matchedSlash){startPart=i+1;break}continue}if(end===-1)matchedSlash=!1,end=i+1;if(code===46){if(startDot===-1)startDot=i;else if(preDotState!==1)preDotState=1}else if(startDot!==-1)preDotState=-1}if(startDot===-1||end===-1||preDotState===0||preDotState===1&&startDot===end-1&&startDot===startPart+1){if(end!==-1)if(startPart===0&&isAbsolute2)ret.base=ret.name=path.slice(1,end);else ret.base=ret.name=path.slice(startPart,end)}else{if(startPart===0&&isAbsolute2)ret.name=path.slice(1,startDot),ret.base=path.slice(1,end);else ret.name=path.slice(startPart,startDot),ret.base=path.slice(startPart,end);ret.ext=path.slice(startDot,end)}if(startPart>0)ret.dir=path.slice(0,startPart-1);else if(isAbsolute2)ret.dir="/";return ret}var sep="/",delimiter=":",posix,path_default;var init_path=__esm(()=>{posix=((p)=>(p.posix=p,p))({resolve,normalize,isAbsolute,join,relative,_makeLong,dirname,basename,extname,format,parse,sep,delimiter,win32:null,posix:null}),path_default=posix});var require_argon2=__commonJS((exports,module)=>{var __dirname="/app/node_modules/argon2-browser/dist",Module2=typeof self!=="undefined"&&typeof self.Module!=="undefined"?self.Module:{},jsModule=Module2,moduleOverrides={},key;for(key in Module2)if(Module2.hasOwnProperty(key))moduleOverrides[key]=Module2[key];var arguments_=[],thisProgram="./this.program",quit_=function(status,toThrow){throw toThrow},ENVIRONMENT_IS_WEB=!1,ENVIRONMENT_IS_WORKER=!1,ENVIRONMENT_IS_NODE=!1,ENVIRONMENT_IS_SHELL=!1;ENVIRONMENT_IS_WEB=typeof window==="object";ENVIRONMENT_IS_WORKER=typeof importScripts==="function";ENVIRONMENT_IS_NODE=typeof process==="object"&&typeof process.versions==="object"&&typeof process.versions.node==="string";ENVIRONMENT_IS_SHELL=!ENVIRONMENT_IS_WEB&&!ENVIRONMENT_IS_NODE&&!ENVIRONMENT_IS_WORKER;var scriptDirectory="";function locateFile(path){if(Module2.locateFile)return Module2.locateFile(path,scriptDirectory);return scriptDirectory+path}var read_,readAsync,readBinary,setWindowTitle,nodeFS,nodePath;if(ENVIRONMENT_IS_NODE){if(ENVIRONMENT_IS_WORKER)scriptDirectory=(init_path(),__toCommonJS(exports_path)).dirname(scriptDirectory)+"/";else scriptDirectory=__dirname+"/";if(read_=function shell_read(filename,binary){if(!nodeFS)nodeFS=(()=>({}));if(!nodePath)nodePath=(init_path(),__toCommonJS(exports_path));return filename=nodePath.normalize(filename),nodeFS.readFileSync(filename,binary?null:"utf8")},readBinary=function readBinary(filename){var ret=read_(filename,!0);if(!ret.buffer)ret=new Uint8Array(ret);return assert(ret.buffer),ret},process.argv.length>1)thisProgram=process.argv[1].replace(/\\/g,"/");if(arguments_=process.argv.slice(2),typeof module!=="undefined")module.exports=Module2;process.on("uncaughtException",function(ex){if(!(ex instanceof ExitStatus))throw ex}),process.on("unhandledRejection",abort),quit_=function(status){process.exit(status)},Module2.inspect=function(){return"[Emscripten Module object]"}}else if(ENVIRONMENT_IS_SHELL){if(typeof read!="undefined")read_=function shell_read(f){return read(f)};if(readBinary=function readBinary(f){var data;if(typeof readbuffer==="function")return new Uint8Array(readbuffer(f));return data=read(f,"binary"),assert(typeof data==="object"),data},typeof scriptArgs!="undefined")arguments_=scriptArgs;else if(typeof arguments!="undefined")arguments_=arguments;if(typeof quit==="function")quit_=function(status){quit(status)};if(typeof print!=="undefined"){if(typeof console==="undefined")console={};console.log=print,console.warn=console.error=typeof printErr!=="undefined"?printErr:print}}else if(ENVIRONMENT_IS_WEB||ENVIRONMENT_IS_WORKER){if(ENVIRONMENT_IS_WORKER)scriptDirectory=self.location.href;else if(typeof document!=="undefined"&&document.currentScript)scriptDirectory=document.currentScript.src;if(scriptDirectory.indexOf("blob:")!==0)scriptDirectory=scriptDirectory.substr(0,scriptDirectory.lastIndexOf("/")+1);else scriptDirectory="";{if(read_=function(url){var xhr=new XMLHttpRequest;return xhr.open("GET",url,!1),xhr.send(null),xhr.responseText},ENVIRONMENT_IS_WORKER)readBinary=function(url){var xhr=new XMLHttpRequest;return xhr.open("GET",url,!1),xhr.responseType="arraybuffer",xhr.send(null),new Uint8Array(xhr.response)};readAsync=function(url,onload,onerror){var xhr=new XMLHttpRequest;xhr.open("GET",url,!0),xhr.responseType="arraybuffer",xhr.onload=function(){if(xhr.status==200||xhr.status==0&&xhr.response){onload(xhr.response);return}onerror()},xhr.onerror=onerror,xhr.send(null)}}setWindowTitle=function(title){document.title=title}}var out=Module2.print||console.log.bind(console),err=Module2.printErr||console.warn.bind(console);for(key in moduleOverrides)if(moduleOverrides.hasOwnProperty(key))Module2[key]=moduleOverrides[key];moduleOverrides=null;if(Module2.arguments)arguments_=Module2.arguments;if(Module2.thisProgram)thisProgram=Module2.thisProgram;if(Module2.quit)quit_=Module2.quit;var wasmBinary;if(Module2.wasmBinary)wasmBinary=Module2.wasmBinary;var noExitRuntime=Module2.noExitRuntime||!0;if(typeof WebAssembly!=="object")abort("no native wasm support detected");var wasmMemory,ABORT=!1,EXITSTATUS;function assert(condition,text){if(!condition)abort("Assertion failed: "+text)}var ALLOC_NORMAL=0,ALLOC_STACK=1;function allocate(slab,allocator){var ret;if(allocator==ALLOC_STACK)ret=stackAlloc(slab.length);else ret=_malloc(slab.length);if(slab.subarray||slab.slice)HEAPU8.set(slab,ret);else HEAPU8.set(new Uint8Array(slab),ret);return ret}var UTF8Decoder=typeof TextDecoder!=="undefined"?new TextDecoder("utf8"):void 0;function UTF8ArrayToString(heap,idx,maxBytesToRead){var endIdx=idx+maxBytesToRead,endPtr=idx;while(heap[endPtr]&&!(endPtr>=endIdx))++endPtr;if(endPtr-idx>16&&heap.subarray&&UTF8Decoder)return UTF8Decoder.decode(heap.subarray(idx,endPtr));else{var str="";while(idx<endPtr){var u0=heap[idx++];if(!(u0&128)){str+=String.fromCharCode(u0);continue}var u1=heap[idx++]&63;if((u0&224)==192){str+=String.fromCharCode((u0&31)<<6|u1);continue}var u2=heap[idx++]&63;if((u0&240)==224)u0=(u0&15)<<12|u1<<6|u2;else u0=(u0&7)<<18|u1<<12|u2<<6|heap[idx++]&63;if(u0<65536)str+=String.fromCharCode(u0);else{var ch=u0-65536;str+=String.fromCharCode(55296|ch>>10,56320|ch&1023)}}}return str}function UTF8ToString(ptr,maxBytesToRead){return ptr?UTF8ArrayToString(HEAPU8,ptr,maxBytesToRead):""}function alignUp(x,multiple){if(x%multiple>0)x+=multiple-x%multiple;return x}var buffer,HEAP8,HEAPU8,HEAP16,HEAPU16,HEAP32,HEAPU32,HEAPF32,HEAPF64;function updateGlobalBufferAndViews(buf){buffer=buf,Module2.HEAP8=HEAP8=new Int8Array(buf),Module2.HEAP16=HEAP16=new Int16Array(buf),Module2.HEAP32=HEAP32=new Int32Array(buf),Module2.HEAPU8=HEAPU8=new Uint8Array(buf),Module2.HEAPU16=HEAPU16=new Uint16Array(buf),Module2.HEAPU32=HEAPU32=new Uint32Array(buf),Module2.HEAPF32=HEAPF32=new Float32Array(buf),Module2.HEAPF64=HEAPF64=new Float64Array(buf)}var INITIAL_MEMORY=Module2.INITIAL_MEMORY||16777216,wasmTable,__ATPRERUN__=[],__ATINIT__=[],__ATPOSTRUN__=[],runtimeInitialized=!1;function preRun(){if(Module2.preRun){if(typeof Module2.preRun=="function")Module2.preRun=[Module2.preRun];while(Module2.preRun.length)addOnPreRun(Module2.preRun.shift())}callRuntimeCallbacks(__ATPRERUN__)}function initRuntime(){runtimeInitialized=!0,callRuntimeCallbacks(__ATINIT__)}function postRun(){if(Module2.postRun){if(typeof Module2.postRun=="function")Module2.postRun=[Module2.postRun];while(Module2.postRun.length)addOnPostRun(Module2.postRun.shift())}callRuntimeCallbacks(__ATPOSTRUN__)}function addOnPreRun(cb){__ATPRERUN__.unshift(cb)}function addOnInit(cb){__ATINIT__.unshift(cb)}function addOnPostRun(cb){__ATPOSTRUN__.unshift(cb)}var runDependencies=0,runDependencyWatcher=null,dependenciesFulfilled=null;function addRunDependency(id){if(runDependencies++,Module2.monitorRunDependencies)Module2.monitorRunDependencies(runDependencies)}function removeRunDependency(id){if(runDependencies--,Module2.monitorRunDependencies)Module2.monitorRunDependencies(runDependencies);if(runDependencies==0){if(runDependencyWatcher!==null)clearInterval(runDependencyWatcher),runDependencyWatcher=null;if(dependenciesFulfilled){var callback=dependenciesFulfilled;dependenciesFulfilled=null,callback()}}}Module2.preloadedImages={};Module2.preloadedAudios={};function abort(what){if(Module2.onAbort)Module2.onAbort(what);what+="",err(what),ABORT=!0,EXITSTATUS=1,what="abort("+what+"). Build with -s ASSERTIONS=1 for more info.";var e=new WebAssembly.RuntimeError(what);throw e}var dataURIPrefix="data:application/octet-stream;base64,";function isDataURI(filename){return filename.startsWith(dataURIPrefix)}function isFileURI(filename){return filename.startsWith("file://")}var wasmBinaryFile="argon2.wasm";if(!isDataURI(wasmBinaryFile))wasmBinaryFile=locateFile(wasmBinaryFile);function getBinary(file){try{if(file==wasmBinaryFile&&wasmBinary)return new Uint8Array(wasmBinary);if(readBinary)return readBinary(file);else throw"both async and sync fetching of the wasm failed"}catch(err2){abort(err2)}}function getBinaryPromise(){if(!wasmBinary&&(ENVIRONMENT_IS_WEB||ENVIRONMENT_IS_WORKER)){if(typeof fetch==="function"&&!isFileURI(wasmBinaryFile))return fetch(wasmBinaryFile,{credentials:"same-origin"}).then(function(response){if(!response.ok)throw"failed to load wasm binary file at '"+wasmBinaryFile+"'";return response.arrayBuffer()}).catch(function(){return getBinary(wasmBinaryFile)});else if(readAsync)return new Promise(function(resolve2,reject){readAsync(wasmBinaryFile,function(response){resolve2(new Uint8Array(response))},reject)})}return Promise.resolve().then(function(){return getBinary(wasmBinaryFile)})}function createWasm(){var info={a:asmLibraryArg};function receiveInstance(instance,module2){var exports3=instance.exports;Module2.asm=exports3,wasmMemory=Module2.asm.c,updateGlobalBufferAndViews(wasmMemory.buffer),wasmTable=Module2.asm.k,addOnInit(Module2.asm.d),removeRunDependency("wasm-instantiate")}addRunDependency("wasm-instantiate");function receiveInstantiationResult(result){receiveInstance(result.instance)}function instantiateArrayBuffer(receiver){return getBinaryPromise().then(function(binary){var result=WebAssembly.instantiate(binary,info);return result}).then(receiver,function(reason){err("failed to asynchronously prepare wasm: "+reason),abort(reason)})}function instantiateAsync(){if(!wasmBinary&&typeof WebAssembly.instantiateStreaming==="function"&&!isDataURI(wasmBinaryFile)&&!isFileURI(wasmBinaryFile)&&typeof fetch==="function")return fetch(wasmBinaryFile,{credentials:"same-origin"}).then(function(response){var result=WebAssembly.instantiateStreaming(response,info);return result.then(receiveInstantiationResult,function(reason){return err("wasm streaming compile failed: "+reason),err("falling back to ArrayBuffer instantiation"),instantiateArrayBuffer(receiveInstantiationResult)})});else return instantiateArrayBuffer(receiveInstantiationResult)}if(Module2.instantiateWasm)try{var exports2=Module2.instantiateWasm(info,receiveInstance);return exports2}catch(e){return err("Module.instantiateWasm callback failed with error: "+e),!1}return instantiateAsync(),{}}function callRuntimeCallbacks(callbacks){while(callbacks.length>0){var callback=callbacks.shift();if(typeof callback=="function"){callback(Module2);continue}var func=callback.func;if(typeof func==="number")if(callback.arg===void 0)wasmTable.get(func)();else wasmTable.get(func)(callback.arg);else func(callback.arg===void 0?null:callback.arg)}}function _emscripten_memcpy_big(dest,src,num){HEAPU8.copyWithin(dest,src,src+num)}function emscripten_realloc_buffer(size){try{return wasmMemory.grow(size-buffer.byteLength+65535>>>16),updateGlobalBufferAndViews(wasmMemory.buffer),1}catch(e){}}function _emscripten_resize_heap(requestedSize){var oldSize=HEAPU8.length;requestedSize=requestedSize>>>0;var maxHeapSize=2147418112;if(requestedSize>maxHeapSize)return!1;for(var cutDown=1;cutDown<=4;cutDown*=2){var overGrownHeapSize=oldSize*(1+0.2/cutDown);overGrownHeapSize=Math.min(overGrownHeapSize,requestedSize+100663296);var newSize=Math.min(maxHeapSize,alignUp(Math.max(requestedSize,overGrownHeapSize),65536)),replacement=emscripten_realloc_buffer(newSize);if(replacement)return!0}return!1}var asmLibraryArg={a:_emscripten_memcpy_big,b:_emscripten_resize_heap},asm=createWasm(),___wasm_call_ctors=Module2.___wasm_call_ctors=function(){return(___wasm_call_ctors=Module2.___wasm_call_ctors=Module2.asm.d).apply(null,arguments)},_argon2_hash=Module2._argon2_hash=function(){return(_argon2_hash=Module2._argon2_hash=Module2.asm.e).apply(null,arguments)},_malloc=Module2._malloc=function(){return(_malloc=Module2._malloc=Module2.asm.f).apply(null,arguments)},_free=Module2._free=function(){return(_free=Module2._free=Module2.asm.g).apply(null,arguments)},_argon2_verify=Module2._argon2_verify=function(){return(_argon2_verify=Module2._argon2_verify=Module2.asm.h).apply(null,arguments)},_argon2_error_message=Module2._argon2_error_message=function(){return(_argon2_error_message=Module2._argon2_error_message=Module2.asm.i).apply(null,arguments)},_argon2_encodedlen=Module2._argon2_encodedlen=function(){return(_argon2_encodedlen=Module2._argon2_encodedlen=Module2.asm.j).apply(null,arguments)},_argon2_hash_ext=Module2._argon2_hash_ext=function(){return(_argon2_hash_ext=Module2._argon2_hash_ext=Module2.asm.l).apply(null,arguments)},_argon2_verify_ext=Module2._argon2_verify_ext=function(){return(_argon2_verify_ext=Module2._argon2_verify_ext=Module2.asm.m).apply(null,arguments)},stackAlloc=Module2.stackAlloc=function(){return(stackAlloc=Module2.stackAlloc=Module2.asm.n).apply(null,arguments)};Module2.allocate=allocate;Module2.UTF8ToString=UTF8ToString;Module2.ALLOC_NORMAL=ALLOC_NORMAL;var calledRun;function ExitStatus(status){this.name="ExitStatus",this.message="Program terminated with exit("+status+")",this.status=status}dependenciesFulfilled=function runCaller(){if(!calledRun)run();if(!calledRun)dependenciesFulfilled=runCaller};function run(args){if(args=args||arguments_,runDependencies>0)return;if(preRun(),runDependencies>0)return;function doRun(){if(calledRun)return;if(calledRun=!0,Module2.calledRun=!0,ABORT)return;if(initRuntime(),Module2.onRuntimeInitialized)Module2.onRuntimeInitialized();postRun()}if(Module2.setStatus)Module2.setStatus("Running..."),setTimeout(function(){setTimeout(function(){Module2.setStatus("")},1),doRun()},1);else doRun()}Module2.run=run;if(Module2.preInit){if(typeof Module2.preInit=="function")Module2.preInit=[Module2.preInit];while(Module2.preInit.length>0)Module2.preInit.pop()()}run();if(typeof module!=="undefined")module.exports=Module2;Module2.unloadRuntime=function(){if(typeof self!=="undefined")delete self.Module;if(Module2=jsModule=wasmMemory=wasmTable=asm=buffer=HEAP8=HEAPU8=HEAP16=HEAPU16=HEAP32=HEAPU32=HEAPF32=HEAPF64=void 0,typeof module!=="undefined")delete module.exports}});var require_argon22=__commonJS((exports,module)=>{module.exports="./argon2.wasm"});var require_argon23=__commonJS((exports,module)=>{(function(root,factory){if(typeof define==="function"&&define.amd)define([],factory);else if(typeof module==="object"&&module.exports)module.exports=factory();else root.argon2=factory()})(typeof self!=="undefined"?self:exports,function(){let global=typeof self!=="undefined"?self:this,ArgonType={Argon2d:0,Argon2i:1,Argon2id:2};function loadModule(mem){if(loadModule._promise)return loadModule._promise;if(loadModule._module)return Promise.resolve(loadModule._module);let promise;if(global.process&&global.process.versions&&global.process.versions.node)promise=loadWasmModule().then((Module2)=>new Promise((resolve2)=>{Module2.postRun=()=>resolve2(Module2)}));else promise=loadWasmBinary().then((wasmBinary)=>{let wasmMemory=mem?createWasmMemory(mem):void 0;return initWasm(wasmBinary,wasmMemory)});return loadModule._promise=promise,promise.then((Module2)=>{return loadModule._module=Module2,delete loadModule._promise,Module2})}function initWasm(wasmBinary,wasmMemory){return new Promise((resolve2)=>{return global.Module={wasmBinary,wasmMemory,postRun(){resolve2(Module)}},loadWasmModule()})}function loadWasmModule(){if(global.loadArgon2WasmModule)return global.loadArgon2WasmModule();return Promise.resolve(require_argon2())}function loadWasmBinary(){if(global.loadArgon2WasmBinary)return global.loadArgon2WasmBinary();return Promise.resolve(require_argon22()).then((wasmModule)=>{return decodeWasmBinary(wasmModule)})}function decodeWasmBinary(base64){let text=atob(base64),binary=new Uint8Array(new ArrayBuffer(text.length));for(let i=0;i<text.length;i++)binary[i]=text.charCodeAt(i);return binary}function createWasmMemory(mem){let initialMemory=Math.min(Math.max(Math.ceil(mem*1024/65536),256)+256,32767);return new WebAssembly.Memory({initial:initialMemory,maximum:32767})}function allocateArray(Module2,arr){return Module2.allocate(arr,"i8",Module2.ALLOC_NORMAL)}function allocateArrayStr(Module2,arr){let nullTerminatedArray=new Uint8Array([...arr,0]);return allocateArray(Module2,nullTerminatedArray)}function encodeUtf8(str){if(typeof str!=="string")return str;if(typeof TextEncoder==="function")return new TextEncoder().encode(str);else if(typeof Buffer==="function")return Buffer.from(str);else throw new Error("Don't know how to encode UTF8")}function argon2Hash(params){let mCost=params.mem||1024;return loadModule(mCost).then((Module2)=>{let tCost=params.time||1,parallelism=params.parallelism||1,pwdEncoded=encodeUtf8(params.pass),pwd=allocateArrayStr(Module2,pwdEncoded),pwdlen=pwdEncoded.length,saltEncoded=encodeUtf8(params.salt),salt=allocateArrayStr(Module2,saltEncoded),saltlen=saltEncoded.length,argon2Type=params.type||ArgonType.Argon2d,hash=Module2.allocate(new Array(params.hashLen||24),"i8",Module2.ALLOC_NORMAL),secret=params.secret?allocateArray(Module2,params.secret):0,secretlen=params.secret?params.secret.byteLength:0,ad=params.ad?allocateArray(Module2,params.ad):0,adlen=params.ad?params.ad.byteLength:0,hashlen=params.hashLen||24,encodedlen=Module2._argon2_encodedlen(tCost,mCost,parallelism,saltlen,hashlen,argon2Type),encoded=Module2.allocate(new Array(encodedlen+1),"i8",Module2.ALLOC_NORMAL),version=19,err,res;try{res=Module2._argon2_hash_ext(tCost,mCost,parallelism,pwd,pwdlen,salt,saltlen,hash,hashlen,encoded,encodedlen,argon2Type,secret,secretlen,ad,adlen,19)}catch(e){err=e}let result;if(res===0&&!err){let hashStr="",hashArr=new Uint8Array(hashlen);for(let i=0;i<hashlen;i++){let byte=Module2.HEAP8[hash+i];hashArr[i]=byte,hashStr+=("0"+(255&byte).toString(16)).slice(-2)}let encodedStr=Module2.UTF8ToString(encoded);result={hash:hashArr,hashHex:hashStr,encoded:encodedStr}}else{try{if(!err)err=Module2.UTF8ToString(Module2._argon2_error_message(res))}catch(e){}result={message:err,code:res}}try{if(Module2._free(pwd),Module2._free(salt),Module2._free(hash),Module2._free(encoded),ad)Module2._free(ad);if(secret)Module2._free(secret)}catch(e){}if(err)throw result;else return result})}function argon2Verify(params){return loadModule().then((Module2)=>{let pwdEncoded=encodeUtf8(params.pass),pwd=allocateArrayStr(Module2,pwdEncoded),pwdlen=pwdEncoded.length,secret=params.secret?allocateArray(Module2,params.secret):0,secretlen=params.secret?params.secret.byteLength:0,ad=params.ad?allocateArray(Module2,params.ad):0,adlen=params.ad?params.ad.byteLength:0,encEncoded=encodeUtf8(params.encoded),enc=allocateArrayStr(Module2,encEncoded),argon2Type=params.type;if(argon2Type===void 0){let typeStr=params.encoded.split("$")[1];if(typeStr)typeStr=typeStr.replace("a","A"),argon2Type=ArgonType[typeStr]||ArgonType.Argon2d}let err,res;try{res=Module2._argon2_verify_ext(enc,pwd,pwdlen,secret,secretlen,ad,adlen,argon2Type)}catch(e){err=e}let result;if(res||err){try{if(!err)err=Module2.UTF8ToString(Module2._argon2_error_message(res))}catch(e){}result={message:err,code:res}}try{Module2._free(pwd),Module2._free(enc)}catch(e){}if(err)throw result;else return result})}function unloadRuntime(){if(loadModule._module)loadModule._module.unloadRuntime(),delete loadModule._promise,delete loadModule._module}return{ArgonType,hash:argon2Hash,verify:argon2Verify,unloadRuntime}})});var SLS_CONSTANTS={CURRENT_DATA_VERSION:2,AES:{NAME:"AES-GCM",LENGTH:256,IV_LENGTH:12},ARGON2:{TYPE:"id",ITERATIONS:20,MEMORY_KIB:65536,PARALLELISM:1,HASH_LEN:32},STORAGE_KEY:"secure-local-storage:v2",IDB:{DB_NAME:"SLS_KEYS",STORE:"keys",ID:"deviceKek_v1"},SALT_LEN:16};class SlsError extends Error{constructor(message){super(message);this.name="SlsError"}}class ValidationError extends SlsError{constructor(message){super(message);this.name="ValidationError"}}class LockedError extends SlsError{constructor(message="Session locked"){super(message);this.name="LockedError"}}class ModeError extends SlsError{constructor(message){super(message);this.name="ModeError"}}class StorageFullError extends SlsError{constructor(message="localStorage quota exceeded"){super(message);this.name="StorageFullError"}}class CryptoError extends SlsError{constructor(message){super(message);this.name="CryptoError"}}class ImportError extends SlsError{constructor(message){super(message);this.name="ImportError"}}class ExportError extends SlsError{constructor(message){super(message);this.name="ExportError"}}class NotSupportedError extends SlsError{constructor(message){super(message);this.name="NotSupportedError"}}function bytesToBase64(bytes){let u8=bytes instanceof Uint8Array?bytes:new Uint8Array(bytes);if(u8.byteLength===0)return"";let binary="";for(let i=0;i<u8.length;i++)binary+=String.fromCharCode(u8[i]);if(typeof btoa==="function")return btoa(binary);return Buffer.from(binary,"binary").toString("base64")}function base64ToBytes(b64){if(typeof b64!=="string"||b64.trim().length===0)throw new ValidationError("Base64 input must be a non-empty string");try{let cleaned=b64.replace(/\s+/g,"").replace(/-/g,"+").replace(/_/g,"/"),pad=cleaned.length%4,normalized=pad===0?cleaned:cleaned+"=".repeat(4-pad);if(typeof atob==="function"){let binary=atob(normalized),out=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++)out[i]=binary.charCodeAt(i);return out}let buf=Buffer.from(normalized,"base64");return new Uint8Array(buf.buffer,buf.byteOffset,buf.byteLength)}catch{throw new ValidationError("Invalid base64 input")}}function toArrayBuffer(u8){if(u8.byteOffset===0&&u8.byteLength===u8.buffer.byteLength&&u8.buffer instanceof ArrayBuffer)return u8.buffer;return u8.slice().buffer}class EncryptionManager{generateSaltB64(){let salt=new Uint8Array(SLS_CONSTANTS.SALT_LEN);return crypto.getRandomValues(salt),bytesToBase64(salt)}async createDek(){try{return await crypto.subtle.generateKey({name:SLS_CONSTANTS.AES.NAME,length:SLS_CONSTANTS.AES.LENGTH},!0,["encrypt","decrypt","wrapKey","unwrapKey"])}catch(e){throw new CryptoError(`Failed to generate DEK: ${e?.message??e}`)}}async encryptData(key,obj){try{let iv=new Uint8Array(SLS_CONSTANTS.AES.IV_LENGTH);crypto.getRandomValues(iv);let data=new TextEncoder().encode(JSON.stringify(obj)),ct=await crypto.subtle.encrypt({name:SLS_CONSTANTS.AES.NAME,iv},key,toArrayBuffer(data));return{iv:bytesToBase64(iv),ciphertext:bytesToBase64(ct)}}catch(e){throw new CryptoError(`Encryption failed: ${e?.message??e}`)}}async decryptData(key,ivB64,ctB64){if(!ivB64||!ctB64)throw new ValidationError("IV and ciphertext are required");let ivBytes,ct;if(ivBytes=base64ToBytes(ivB64),ct=base64ToBytes(ctB64),ivBytes.byteLength!==SLS_CONSTANTS.AES.IV_LENGTH)throw new ValidationError(`IV must be ${SLS_CONSTANTS.AES.IV_LENGTH} bytes`);let pt;try{pt=await crypto.subtle.decrypt({name:SLS_CONSTANTS.AES.NAME,iv:ivBytes},key,toArrayBuffer(ct))}catch(e){throw new CryptoError("Invalid key or data.")}try{return JSON.parse(new TextDecoder().decode(pt))}catch{throw new ValidationError("Decrypted data is not valid JSON")}}async unwrapDek(ivWrapB64,wrappedB64,kek,forWrapping=!1){let ivBytes,wrapped;if(ivBytes=base64ToBytes(ivWrapB64),wrapped=base64ToBytes(wrappedB64),ivBytes.byteLength!==SLS_CONSTANTS.AES.IV_LENGTH)throw new ValidationError(`Wrap IV must be ${SLS_CONSTANTS.AES.IV_LENGTH} bytes`);try{return await crypto.subtle.unwrapKey("raw",toArrayBuffer(wrapped),kek,{name:SLS_CONSTANTS.AES.NAME,iv:ivBytes},{name:SLS_CONSTANTS.AES.NAME,length:SLS_CONSTANTS.AES.LENGTH},forWrapping,forWrapping?["wrapKey","unwrapKey","encrypt","decrypt"]:["encrypt","decrypt"])}catch(e){throw new CryptoError("Invalid key or data.")}}async wrapDek(dek,kek){try{let iv=new Uint8Array(SLS_CONSTANTS.AES.IV_LENGTH);crypto.getRandomValues(iv);let wrapped=await crypto.subtle.wrapKey("raw",dek,kek,{name:SLS_CONSTANTS.AES.NAME,iv});return{ivWrap:bytesToBase64(iv),wrappedKey:bytesToBase64(wrapped)}}catch(e){throw new CryptoError(`wrapKey failed: ${e?.message??e}`)}}}function resolveIdbConfig(cfg){return{dbName:cfg?.dbName??SLS_CONSTANTS.IDB.DB_NAME,storeName:cfg?.storeName??SLS_CONSTANTS.IDB.STORE,keyId:cfg?.keyId??SLS_CONSTANTS.IDB.ID}}function memKeyId(cfg){return`${cfg.dbName}::${cfg.storeName}::${cfg.keyId}`}class DeviceKeyProvider{static memoryKeys=new Map;static async getKey(cfgIn){let cfg=resolveIdbConfig(cfgIn),mk=memKeyId(cfg),existingMem=this.memoryKeys.get(mk);if(existingMem)return existingMem;if(!globalThis.indexedDB){let k=await this.generateKek();return this.memoryKeys.set(mk,k),k}let db=await this.openDB(cfg).catch(()=>null);try{if(!db){let k=await this.generateKek();return this.memoryKeys.set(mk,k),k}let existing=await new Promise((resolve,reject)=>{let req=db.transaction(cfg.storeName,"readonly").objectStore(cfg.storeName).get(cfg.keyId);req.onsuccess=()=>resolve(req.result?.key||void 0),req.onerror=()=>reject(req.error)});if(existing)return this.memoryKeys.set(mk,existing),existing;let key=await this.generateKek();return await new Promise((resolve,reject)=>{let put=db.transaction(cfg.storeName,"readwrite").objectStore(cfg.storeName).put({id:cfg.keyId,key});put.onsuccess=()=>resolve(),put.onerror=()=>reject(put.error)}).catch(()=>{}),this.memoryKeys.set(mk,key),key}catch{let k=this.memoryKeys.get(mk);if(!k)k=await this.generateKek(),this.memoryKeys.set(mk,k);return k}finally{if(db)db.close()}}static async rotateKey(cfgIn){let cfg=resolveIdbConfig(cfgIn),mk=memKeyId(cfg),newKey=await this.generateKek();if(!globalThis.indexedDB)return this.memoryKeys.set(mk,newKey),newKey;let db=await this.openDB(cfg).catch(()=>null);try{if(!db)return this.memoryKeys.set(mk,newKey),newKey;return await new Promise((resolve,reject)=>{let put=db.transaction(cfg.storeName,"readwrite").objectStore(cfg.storeName).put({id:cfg.keyId,key:newKey});put.onsuccess=()=>resolve(),put.onerror=()=>reject(put.error)}),this.memoryKeys.set(mk,newKey),newKey}catch{return this.memoryKeys.set(mk,newKey),newKey}finally{if(db)db.close()}}static async deletePersistent(cfgIn){let cfg=resolveIdbConfig(cfgIn);if(this.memoryKeys.delete(memKeyId(cfg)),!globalThis.indexedDB)return;let db=await this.openDB(cfg).catch(()=>null);if(db)try{await new Promise((resolve,reject)=>{let del=db.transaction(cfg.storeName,"readwrite").objectStore(cfg.storeName).delete(cfg.keyId);del.onsuccess=()=>resolve(),del.onerror=()=>reject(del.error)}),db.close();return}catch{db.close()}await new Promise((resolve)=>{let req=indexedDB.deleteDatabase(cfg.dbName);req.onsuccess=()=>resolve(),req.onerror=()=>resolve()})}static async generateKek(){return await crypto.subtle.generateKey({name:SLS_CONSTANTS.AES.NAME,length:SLS_CONSTANTS.AES.LENGTH},!1,["wrapKey","unwrapKey"])}static openDB(cfg){return new Promise((resolve,reject)=>{try{let req=indexedDB.open(cfg.dbName,1);req.onupgradeneeded=()=>{if(!req.result.objectStoreNames.contains(cfg.storeName))req.result.createObjectStore(cfg.storeName,{keyPath:"id"})},req.onsuccess=()=>resolve(req.result),req.onerror=()=>reject(new NotSupportedError(req.error?.message??"IndexedDB error"))}catch(e){reject(new NotSupportedError(e?.message??"IndexedDB unavailable"))}})}}var argon2=__toESM(require_argon23(),1);function toArrayBuffer2(u8){if(u8.byteOffset===0&&u8.byteLength===u8.buffer.byteLength&&u8.buffer instanceof ArrayBuffer)return u8.buffer;return u8.slice().buffer}async function deriveKekFromPassword(password,salt,iterations=SLS_CONSTANTS.ARGON2.ITERATIONS){if(typeof password!=="string"||password.length===0)throw new ValidationError("Password must be a non-empty string");if(!(salt instanceof Uint8Array)||salt.byteLength<SLS_CONSTANTS.SALT_LEN)throw new ValidationError(`Salt must be Uint8Array with length >= ${SLS_CONSTANTS.SALT_LEN}`);let MAX_ITERATIONS=64;if(!Number.isInteger(iterations)||iterations<1||iterations>MAX_ITERATIONS)throw new ValidationError(`iterations must be an integer in [1, ${MAX_ITERATIONS}]`);let result;try{result=await argon2.hash({pass:password,salt,time:iterations,mem:SLS_CONSTANTS.ARGON2.MEMORY_KIB,hashLen:SLS_CONSTANTS.ARGON2.HASH_LEN,parallelism:SLS_CONSTANTS.ARGON2.PARALLELISM,type:argon2.ArgonType.Argon2id})}catch(e){throw new CryptoError(`Argon2 derivation failed: ${e?.message??e}`)}if(!result?.hash)throw new CryptoError("Argon2 returned no hash");try{return await crypto.subtle.importKey("raw",toArrayBuffer2(result.hash),{name:SLS_CONSTANTS.AES.NAME,length:SLS_CONSTANTS.AES.LENGTH},!1,["wrapKey","unwrapKey"])}catch(e){throw new CryptoError(`Failed to import derived key: ${e?.message??e}`)}}class SessionKeyCache{key=null;saltB64=null;rounds=null;set(key,saltB64,rounds){this.key=key,this.saltB64=saltB64,this.rounds=rounds}match(saltB64,rounds){if(!this.key)return null;if(this.saltB64===saltB64&&this.rounds===rounds)return this.key;return null}clear(){this.key=null,this.saltB64=null,this.rounds=null}}function estimateBytes(s){try{return new Blob([s]).size}catch{return s.length}}class StorageService{key;constructor(key=SLS_CONSTANTS.STORAGE_KEY){this.key=key}get(){let raw=localStorage.getItem(this.key);if(!raw)return null;try{return JSON.parse(raw)}catch{return null}}_isQuotaExceeded(err){let e=err,name=e?.name??"",msg=e?.message??"",code=e?.code;return name==="QuotaExceededError"||name==="NS_ERROR_DOM_QUOTA_REACHED"||code===22||code===1014||/quota/i.test(msg)}set(cfg){let serialized=JSON.stringify(cfg);try{if(localStorage.setItem(this.key,serialized),localStorage.getItem(this.key)!==serialized)throw new StorageFullError("Failed to persist data")}catch(e){if(this._isQuotaExceeded(e))throw new StorageFullError(`localStorage quota exceeded (${estimateBytes(serialized)} bytes)`);let msg=e?.message??String(e);throw new StorageFullError(`Failed to persist data: ${msg}`)}}clear(){try{localStorage.removeItem(this.key)}catch{}}}function toPlainJson(value){let seen=new WeakSet,replacer=(_key,v)=>{let t=typeof v;if(t==="function"||t==="symbol")throw new ValidationError("Data must be JSON-serializable (no functions/symbols)");if(v&&t==="object"){let o=v;if(seen.has(o))throw new ValidationError("Data must be JSON-serializable (no circular references)");seen.add(o)}return v};try{return JSON.parse(JSON.stringify(value,replacer))}catch(e){if(e instanceof ValidationError)throw e;throw new ValidationError("Data must be JSON-serializable")}}function makeSecureDataView(payloadIn){let cleared=!1,payload=payloadIn,nestedCache=new WeakMap;function clear(){let overwrite=(obj)=>{if(!obj||typeof obj!=="object")return;let rec=obj;for(let key of Object.keys(rec)){let v=rec[key];if(v&&typeof v==="object")overwrite(v);rec[key]=null}};overwrite(payload),cleared=!0,payload={},nestedCache=new WeakMap}let readonlyError=()=>new ValidationError("SecureDataView is read-only; mutate via setData()"),wrapNested=(obj)=>{if(!obj||typeof obj!=="object")return obj;let cached=nestedCache.get(obj);if(cached)return cached;let proxied=new Proxy(obj,{get(target,prop){if(cleared)throw new LockedError("Decrypted data was cleared");let v=target[prop];return typeof v==="object"&&v!==null?wrapNested(v):v},set(){throw readonlyError()},defineProperty(){throw readonlyError()},deleteProperty(){throw readonlyError()},ownKeys(target){if(cleared)throw new LockedError("Decrypted data was cleared");return Reflect.ownKeys(target)},getOwnPropertyDescriptor(target,prop){if(cleared)throw new LockedError("Decrypted data was cleared");if(Object.prototype.hasOwnProperty.call(target,prop))return{configurable:!0,enumerable:!0,writable:!1,value:target[prop]};return},has(target,prop){if(cleared)throw new LockedError("Decrypted data was cleared");return Reflect.has(target,prop)}});return nestedCache.set(obj,proxied),proxied};return new Proxy({},{get(_,prop){if(prop==="clear")return clear;if(cleared)throw new LockedError("Decrypted data was cleared");let v=payload[prop];return typeof v==="object"&&v!==null?wrapNested(v):v},set(){throw readonlyError()},defineProperty(){throw readonlyError()},deleteProperty(){throw readonlyError()},ownKeys(){if(cleared)throw new LockedError("Decrypted data was cleared");return[...Object.keys(payload),"clear"]},getOwnPropertyDescriptor(_,prop){if(prop==="clear")return{configurable:!0,enumerable:!0,writable:!1,value:clear};if(cleared)throw new LockedError("Decrypted data was cleared");if(Object.prototype.hasOwnProperty.call(payload,prop))return{configurable:!0,enumerable:!0,writable:!1,value:payload[prop]};return},has(_,prop){if(prop==="clear")return!0;if(cleared)throw new LockedError("Decrypted data was cleared");return Object.prototype.hasOwnProperty.call(payload,prop)}})}class SecureLocalStorage{store;enc=new EncryptionManager;session=new SessionKeyCache;config=null;dek=null;ready;idbConfig;DATA_VERSION=SLS_CONSTANTS.CURRENT_DATA_VERSION;constructor(opts){this.store=new StorageService(opts?.storageKey),this.idbConfig={dbName:opts?.idbConfig?.dbName??SLS_CONSTANTS.IDB.DB_NAME,storeName:opts?.idbConfig?.storeName??SLS_CONSTANTS.IDB.STORE,keyId:opts?.idbConfig?.keyId??SLS_CONSTANTS.IDB.ID},this.ready=this.initialize()}isUsingMasterPassword(){return(this.config?.header.rounds??1)>1}isLocked(){return this.isUsingMasterPassword()&&!this.dek}async unlock(masterPassword){if(await this.ready,!this.config)return;if(!this.isUsingMasterPassword())return;if(typeof masterPassword!=="string"||masterPassword.trim().length===0)throw new ValidationError("masterPassword must be a non-empty string");let{salt,rounds}=this.config.header,kek=await deriveKekFromPassword(masterPassword,base64ToBytes(salt),rounds);try{this.session.set(kek,salt,rounds),await this.unwrapDekWithKek(kek,!1)}catch{throw this.session.clear(),new ValidationError("Invalid master password")}}async setMasterPassword(masterPassword){if(await this.ready,this.requireConfig(),this.isUsingMasterPassword())throw new ModeError("Master password already set; use rotateMasterPassword()");if(typeof masterPassword!=="string"||masterPassword.length===0)throw new ValidationError("masterPassword must be a non-empty string");let deviceKek=await DeviceKeyProvider.getKey(this.idbConfig);await this.unwrapDekWithKek(deviceKek,!0);let saltB64=this.enc.generateSaltB64(),kek=await deriveKekFromPassword(masterPassword,base64ToBytes(saltB64)),wrapped=await this.enc.wrapDek(this.dek,kek);this.config.header={v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:saltB64,rounds:SLS_CONSTANTS.ARGON2.ITERATIONS,iv:wrapped.ivWrap,wrappedKey:wrapped.wrappedKey},this.session.set(kek,saltB64,SLS_CONSTANTS.ARGON2.ITERATIONS),this.dek=await this.enc.unwrapDek(wrapped.ivWrap,wrapped.wrappedKey,kek,!1),this.persist()}async removeMasterPassword(){if(await this.ready,this.requireConfig(),!this.isUsingMasterPassword())throw new ModeError("No master password is set");this.requireUnlocked();let deviceKek=await DeviceKeyProvider.getKey(this.idbConfig);await this.unwrapDekWithKek(this.sessionKekOrThrow(),!0);let{ivWrap,wrappedKey}=await this.enc.wrapDek(this.dek,deviceKek);this.config.header={v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:"",rounds:1,iv:ivWrap,wrappedKey},this.dek=await this.enc.unwrapDek(ivWrap,wrappedKey,deviceKek,!1),this.session.clear(),this.persist()}async rotateMasterPassword(oldMasterPassword,newMasterPassword){if(await this.ready,this.requireConfig(),typeof newMasterPassword!=="string"||newMasterPassword.length===0)throw new ValidationError("newMasterPassword must be a non-empty string");if(!this.isUsingMasterPassword()){await this.unlock(oldMasterPassword),await this.setMasterPassword(newMasterPassword);return}await this.unlock(oldMasterPassword),this.requireUnlocked(),await this.unwrapDekWithKek(this.sessionKekOrThrow(),!0);let saltB64=this.enc.generateSaltB64(),rounds=SLS_CONSTANTS.ARGON2.ITERATIONS,newKek=await deriveKekFromPassword(newMasterPassword,base64ToBytes(saltB64),rounds),{ivWrap,wrappedKey}=await this.enc.wrapDek(this.dek,newKek);this.config.header={v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:saltB64,rounds,iv:ivWrap,wrappedKey},this.session.set(newKek,saltB64,rounds),this.dek=await this.enc.unwrapDek(ivWrap,wrappedKey,newKek,!1),this.persist()}lock(){this.session.clear(),this.dek=null}async rotateKeys(){if(await this.ready,this.requireConfig(),this.isUsingMasterPassword())throw new ModeError("rotateKeys is allowed only in password-less mode");let deviceKek=await DeviceKeyProvider.getKey(this.idbConfig);await this.unwrapDekWithKek(deviceKek,!1);let plain=await this.enc.decryptData(this.dek,this.config.data.iv,this.config.data.ciphertext),newDek=await this.enc.createDek(),{iv,ciphertext}=await this.enc.encryptData(newDek,plain),newDeviceKek=await DeviceKeyProvider.rotateKey(this.idbConfig),{ivWrap,wrappedKey}=await this.enc.wrapDek(newDek,newDeviceKek);this.config.header={v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:"",rounds:1,iv:ivWrap,wrappedKey},this.config.data={iv,ciphertext},this.dek=await this.enc.unwrapDek(ivWrap,wrappedKey,newDeviceKek,!1);for(let k of Object.keys(plain))plain[k]=null;this.persist()}async getData(){if(await this.ready,this.requireConfig(),await this.ensureDekLoaded(),!this.config.data.iv||!this.config.data.ciphertext)return makeSecureDataView({});let obj=await this.enc.decryptData(this.dek,this.config.data.iv,this.config.data.ciphertext);if(!(!!obj&&typeof obj==="object"&&!Array.isArray(obj)&&Object.getPrototypeOf(obj)===Object.prototype))throw new ValidationError("Stored data must be a plain object");return makeSecureDataView(obj)}async setData(value){if(await this.ready,this.requireConfig(),await this.ensureDekLoaded(),!value||typeof value!=="object"||Array.isArray(value))throw new ValidationError("Data must be a plain object");let plain=toPlainJson(value),{iv,ciphertext}=await this.enc.encryptData(this.dek,plain);this.config.data={iv,ciphertext},this.persist()}async exportData(customExportPassword){if(await this.ready,this.requireConfig(),!customExportPassword&&this.isUsingMasterPassword()){let copy=structuredClone(this.config);return copy.header.mPw=!0,JSON.stringify(copy)}if(!customExportPassword&&!this.isUsingMasterPassword())throw new ExportError("Export password required in device mode");if(customExportPassword!==void 0&&(typeof customExportPassword!=="string"||customExportPassword.trim().length===0))throw new ExportError("Export password must be a non-empty string");try{let exportSaltB64=this.enc.generateSaltB64(),exportKek=await deriveKekFromPassword(customExportPassword,base64ToBytes(exportSaltB64));if(this.isUsingMasterPassword())await this.unwrapDekWithKek(this.sessionKekOrThrow(),!0);else{let deviceKek=await DeviceKeyProvider.getKey(this.idbConfig);await this.unwrapDekWithKek(deviceKek,!0)}let{ivWrap,wrappedKey}=await this.enc.wrapDek(this.dek,exportKek),bundle={header:{v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:exportSaltB64,rounds:SLS_CONSTANTS.ARGON2.ITERATIONS,iv:ivWrap,wrappedKey,mPw:!1},data:this.config.data};return JSON.stringify(bundle)}catch(e){throw new ExportError(e?.message??"Export failed")}}async importData(serialized,password){await this.ready;let bundle;try{bundle=JSON.parse(serialized)}catch{throw new ImportError("Invalid import JSON")}if(bundle.header.v!==SLS_CONSTANTS.CURRENT_DATA_VERSION)throw new ImportError(`Unsupported export version ${bundle.header.v}`);this.validateBundle(bundle);let isMasterProtected=bundle.header.mPw===!0||bundle.header.rounds>1&&bundle.header.mPw!==!1;if(typeof password!=="string"||password.length===0)throw new ImportError(isMasterProtected?"Master password required to import":"Export password required to import");if(isMasterProtected){try{let kek=await deriveKekFromPassword(password,base64ToBytes(bundle.header.salt),bundle.header.rounds);await this.enc.unwrapDek(bundle.header.iv,bundle.header.wrappedKey,kek,!1)}catch{throw new ImportError("Invalid master password or corrupted export data")}return this.config=bundle,this.dek=null,this.session.clear(),this.persist(),"masterPassword"}try{let exportKek=await deriveKekFromPassword(password,base64ToBytes(bundle.header.salt),bundle.header.rounds),extractableDek=await this.enc.unwrapDek(bundle.header.iv,bundle.header.wrappedKey,exportKek,!0),deviceKek=await DeviceKeyProvider.getKey(this.idbConfig),{ivWrap,wrappedKey}=await this.enc.wrapDek(extractableDek,deviceKek);return this.config={header:{v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:"",rounds:1,iv:ivWrap,wrappedKey},data:bundle.data},this.dek=await this.enc.unwrapDek(ivWrap,wrappedKey,deviceKek,!1),this.session.clear(),this.persist(),"customExportPassword"}catch(e){throw new ImportError("Invalid export password or corrupted export data")}}async clear(){await this.ready,this.session.clear(),this.dek=null,this.store.clear(),await DeviceKeyProvider.deletePersistent(this.idbConfig),await this.initialize(!0)}async initialize(forceFresh=!1){let isValidConfig=(cfg)=>{if(!cfg)return!1;let{header:h,data:d}=cfg;if(!h||h.v!==SLS_CONSTANTS.CURRENT_DATA_VERSION)return!1;if(typeof h.rounds!=="number"||h.rounds<1)return!1;if(typeof h.iv!=="string"||typeof h.wrappedKey!=="string")return!1;if(!d||typeof d.iv!=="string"||typeof d.ciphertext!=="string")return!1;if(h.rounds===1){if(h.salt!=="")return!1}else if(typeof h.salt!=="string"||h.salt.length===0)return!1;try{if(base64ToBytes(h.iv),base64ToBytes(h.wrappedKey),d.iv)base64ToBytes(d.iv);if(d.ciphertext)base64ToBytes(d.ciphertext)}catch{return!1}return!0};if(forceFresh){let dek=await this.enc.createDek(),deviceKek=await DeviceKeyProvider.getKey(this.idbConfig),{ivWrap,wrappedKey}=await this.enc.wrapDek(dek,deviceKek),unwrappedDek=await this.enc.unwrapDek(ivWrap,wrappedKey,deviceKek,!1),{iv,ciphertext}=await this.enc.encryptData(unwrappedDek,{});this.config={header:{v:SLS_CONSTANTS.CURRENT_DATA_VERSION,salt:"",rounds:1,iv:ivWrap,wrappedKey},data:{iv,ciphertext}},this.dek=unwrappedDek,this.persist();return}let existing=this.store.get();if(!isValidConfig(existing)){await this.initialize(!0);return}if(this.config=existing,!this.isUsingMasterPassword()){let deviceKek=await DeviceKeyProvider.getKey(this.idbConfig);try{this.dek=await this.enc.unwrapDek(existing.header.iv,existing.header.wrappedKey,deviceKek,!1)}catch{await this.initialize(!0)}}}persist(){this.store.set(this.config)}requireConfig(){if(!this.config)throw new ImportError("No configuration present")}requireUnlocked(){if(!this.dek)throw new LockedError}sessionKekOrThrow(){let{salt,rounds}=this.config.header,kek=this.session.match(salt,rounds);if(!kek)throw new LockedError("Session locked.");return kek}async ensureDekLoaded(){if(this.dek)return;if(this.isUsingMasterPassword()){let kek=this.sessionKekOrThrow();await this.unwrapDekWithKek(kek,!1)}else{let deviceKek=await DeviceKeyProvider.getKey(this.idbConfig);await this.unwrapDekWithKek(deviceKek,!1)}}async unwrapDekWithKek(kek,forWrapping){this.dek=await this.enc.unwrapDek(this.config.header.iv,this.config.header.wrappedKey,kek,forWrapping)}validateBundle(bundle){let h=bundle?.header,d=bundle?.data;if(!h||!d)throw new ImportError("Invalid export structure");if(typeof h.iv!=="string"||h.iv.length===0)throw new ImportError("Invalid header.iv");if(typeof h.wrappedKey!=="string"||h.wrappedKey.length===0)throw new ImportError("Invalid header.wrappedKey");if(!Number.isInteger(h.rounds)||h.rounds<1)throw new ImportError("Invalid header.rounds");if(h.rounds===1){if(h.salt!=="")throw new ImportError("Device-mode bundles must have empty salt")}else if(typeof h.salt!=="string"||h.salt.length===0)throw new ImportError("Password-protected bundles must include non-empty salt");if("mPw"in h&&typeof h.mPw!=="boolean")throw new ImportError("Invalid header.mPw");if(typeof d.iv!=="string"||typeof d.ciphertext!=="string")throw new ImportError("Invalid data section");try{if(base64ToBytes(h.iv),base64ToBytes(h.wrappedKey),d.iv)base64ToBytes(d.iv);if(d.ciphertext)base64ToBytes(d.ciphertext)}catch(e){throw new ImportError("Invalid base64 data")}}}function secureLocalStorage(opts){return new SecureLocalStorage(opts)}export{secureLocalStorage as default,SecureLocalStorage};

//# debugId=B2189FC7ACD727E864756E2164756E21
