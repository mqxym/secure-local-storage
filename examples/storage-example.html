<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>secure-local-storage // Example</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script>
  //This needs to be done
  window.loadArgon2WasmBinary = () =>
    fetch("./dist/argon2.wasm")
      .then(r => r.arrayBuffer())
      .then(buf => new Uint8Array(buf));

  </script>
</head>
<body class="text-white">
  <nav class="navbar navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container-fluid">
      <span class="navbar-brand">secure-local-storage — Demo</span>
      <div class="d-flex gap-2 align-items-center">
        <span class="badge rounded-pill badge-soft" id="modeBadge">mode: unknown</span>
        <span class="badge rounded-pill badge-amber" id="lockBadge">locked: unknown</span>
        <button class="btn btn-sm btn-outline-light" id="btnRefresh">Refresh</button>
      </div>
    </div>
  </nav>

  <main class="container-lg pb-5">
    <div id="alertHost" class="mb-3"></div>

    <div class="row g-4">
      <!-- Left column: actions -->
      <div class="col-12 col-xl-6">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Data</h5>

          </div>
          <div class="card-body">
            <form id="formSetData" class="vstack gap-3">
              <label class="form-label">Set data (JSON)</label>
              <textarea class="form-control" id="inputJson" rows="8" placeholder='{"value1":123,"nested":{"a":"b"}}'>{"value1":123,"nested":{"a":"b"}}</textarea>
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">Saved via AES-GCM-256 DEK wrapped with device KEK or Argon2id-derived KEK.</small>
                <button class="btn btn-primary" type="submit">Save</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header"><h5 class="mb-0">Session & Keys</h5></div>
          <div class="card-body vstack gap-3">
            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Master password</label>
                <input type="password" class="form-control" id="masterPwd" placeholder="••••••" autocomplete="new-password" />
              </div>
              <div class="col-md-6 d-flex gap-2">
                <button class="btn btn-primary flex-fill" id="btnSetMaster">Set master</button>
                <button class="btn btn-outline-dark flex-fill" id="btnUnlock">Unlock</button>
              </div>
            </div>
            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Rotate master password</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="oldPwd" placeholder="old" autocomplete="current-password" />
                  <span class="input-group-text">→</span>
                  <input type="password" class="form-control" id="newPwd" placeholder="new" autocomplete="new-password" />
                </div>
              </div>
              <div class="col-md-6 d-flex gap-2">
                <button class="btn btn-warning flex-fill" id="btnRotateMaster">Rotate</button>
                <button class="btn btn-outline-danger flex-fill" id="btnRemoveMaster">Remove master</button>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-dark" id="btnLock">Lock</button>
              <button class="btn btn-outline-info" id="btnRotateKeys">Rotate keys (password‑less)</button>
              <button class="btn btn-outline-danger ms-auto" id="btnClearAll">Clear all</button>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header"><h5 class="mb-0">Export / Import</h5></div>
          <div class="card-body vstack gap-3">
            <div class="row g-2 align-items-end">
              <div class="col-md-7">
                <label class="form-label">Export password (optional when in master mode)</label>
                <input type="password" class="form-control" id="exportPwd" placeholder="export password" />
              </div>
              <div class="col-md-5 d-flex gap-2">
                <button class="btn btn-primary flex-fill" id="btnExport">Export</button>
                <button class="btn btn-outline-dark flex-fill" id="btnDownload">Download</button>
              </div>
            </div>
            <label class="form-label">Export JSON</label>
            <textarea class="form-control" id="exportOut" rows="6" placeholder="exported JSON will appear here"></textarea>

            <hr/>

            <label class="form-label">Import JSON</label>
            <textarea class="form-control" id="importIn" rows="6" placeholder="paste previously exported JSON"></textarea>
            <div class="row g-2 align-items-end">
              <div class="col-md-7">
                <label class="form-label">Password (master or export password)</label>
                <input type="password" class="form-control" id="importPwd" placeholder="password used for export" />
              </div>
              <div class="col-md-5 d-flex gap-2">
                <button class="btn btn-success flex-fill" id="btnImport">Import</button>
                <button class="btn btn-outline-dark flex-fill" id="btnLoadFile">Load file…</button>
                <input type="file" class="d-none" id="fileOpen" accept="application/json,.json" />
              </div>
            </div>
            <div class="text-muted"><small>• If export used a custom password, provide it here. If export used the master password, provide the master password.</small></div>
          </div>
        </div>
      </div>

      <!-- Right column: live views -->
      <div class="col-12 col-xl-6">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Decrypted data view</h5>
            <span class="text-muted small">(wiped independently from storage)</span>
            <div>
              <button class="btn btn-sm btn-dark" id="btnGetData">Get data</button>
              <button class="btn btn-sm btn-dark" id="btnClearView">Clear view</button>
            </div>
          </div>
          <div class="card-body">
            <pre class="text-info" id="plainOut">(empty)</pre>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Persisted payload (localStorage)</h5>
            <span class="text-muted small"><code>secure-local-storage:v2</code></span>
          </div>
          <div class="card-body">
            <pre class="text-warning" id="storedOut">(empty)</pre>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h5 class="mb-0">Logs</h5></div>
          <div class="card-body">
            <pre class="text-secondary" id="logOut"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import secureLocalStorage from "./dist/sls.browser.min.js";

    const sls = secureLocalStorage();

    // --- UI elements ---
    const modeBadge   = document.getElementById("modeBadge");
    const lockBadge   = document.getElementById("lockBadge");
    const btnRefresh  = document.getElementById("btnRefresh");
    const alertHost   = document.getElementById("alertHost");

    const plainOut    = document.getElementById("plainOut");
    const storedOut   = document.getElementById("storedOut");
    const logOut      = document.getElementById("logOut");

    const formSetData = document.getElementById("formSetData");
    const inputJson   = document.getElementById("inputJson");

    const btnGetData  = document.getElementById("btnGetData");
    const btnClearView= document.getElementById("btnClearView");

    const masterPwd   = document.getElementById("masterPwd");
    const btnSetMaster= document.getElementById("btnSetMaster");
    const btnUnlock   = document.getElementById("btnUnlock");
    const btnLock     = document.getElementById("btnLock");
    const btnRotateKeys = document.getElementById("btnRotateKeys");
    const btnClearAll = document.getElementById("btnClearAll");

    const oldPwd      = document.getElementById("oldPwd");
    const newPwd      = document.getElementById("newPwd");
    const btnRotateMaster = document.getElementById("btnRotateMaster");
    const btnRemoveMaster = document.getElementById("btnRemoveMaster");

    const exportPwd   = document.getElementById("exportPwd");
    const btnExport   = document.getElementById("btnExport");
    const btnDownload = document.getElementById("btnDownload");
    const exportOut   = document.getElementById("exportOut");

    const importIn    = document.getElementById("importIn");
    const importPwd   = document.getElementById("importPwd");
    const btnImport   = document.getElementById("btnImport");
    const btnLoadFile = document.getElementById("btnLoadFile");
    const fileOpen    = document.getElementById("fileOpen");

    // --- state ---
    const state = {
      mode: "passwordless",  // we update when setting/removing master/importing
      locked: true,
      lastView: null
    };

    function showAlert(kind, msg) {
      const el = document.createElement("div");
      el.className = `alert alert-${kind} alert-dismissible fade show`;
      el.role = "alert";
      el.innerHTML = `<div>${msg}</div><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
      alertHost.appendChild(el);
      setTimeout(() => el.classList.add("show"), 10);
      setTimeout(() => el.remove(), 8000);
    }

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logOut.textContent += `[${time}] ${msg}\n`;
      logOut.scrollTop = logOut.scrollHeight;
    }

    function setMode(mode) {
      state.mode = mode;
      modeBadge.textContent = `mode: ${mode}`;
    }

    function setLocked(locked) {
      state.locked = locked;
      lockBadge.textContent = `locked: ${locked ? "yes" : "no"}`;
    }

    function pretty(obj) {
      try { return JSON.stringify(obj, null, 2); } catch { return String(obj); }
    }

    function refreshStored() {
      try {
        const raw = localStorage.getItem("secure-local-storage:v2");
        storedOut.textContent = raw ? pretty(JSON.parse(raw)) : "(empty)";
      } catch {
        storedOut.textContent = "(corrupted or unavailable)";
      }
    }

    async function detectLockState() {
      if (!sls.isUsingMasterPassword()){
        setMode("passwordless")
        setLocked(false);
      } else {
        setMode("master");
        setLocked(true);
      }
    }

    // --- events ---
    btnRefresh.addEventListener("click", async () => {
      await detectLockState();
      refreshStored();
      showAlert("info", "Refreshed status & stored payload.");
    });

    formSetData.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const value = inputJson.value.trim() ? JSON.parse(inputJson.value) : {};
        await sls.setData(value);
        setLocked(false);
        refreshStored();
        showAlert("success", "Data saved");
        log("setData ✓");
      } catch (err) {
        showAlert("danger", `setData error: ${err?.message ?? err}`);
        log(`setData ✗ ${err?.message ?? err}`);
      }
    });

    btnGetData.addEventListener("click", async () => {
      try {
        const view = await sls.getData();
        state.lastView = view;
        plainOut.textContent = pretty(view);
        setLocked(false);
        log("getData ✓");
      } catch (err) {
        showAlert("warning", `getData error: ${err?.message ?? err}`);
        setLocked(true);
        log(`getData ✗ ${err?.message ?? err}`);
      }
    });

    btnClearView.addEventListener("click", () => {
      try {
        if (state.lastView) state.lastView.clear();
        state.lastView = null;
        plainOut.textContent = "(empty)";
        showAlert("secondary", "Decrypted view cleared from memory");
        log("view.clear() ✓");
      } catch (err) {
        showAlert("warning", `clear view: ${err?.message ?? err}`);
      }
    });

    btnSetMaster.addEventListener("click", async () => {
      try {
        const pwd = masterPwd.value;
        if (!pwd) throw new Error("Enter a master password");
        await sls.setMasterPassword(pwd);
        setMode("master");
        setLocked(false);
        refreshStored();
        showAlert("success", "Master password set");
        log("setMasterPassword ✓");
      } catch (err) {
        showAlert("danger", `setMasterPassword: ${err?.message ?? err}`);
      }
    });

    btnUnlock.addEventListener("click", async () => {
      try {
        const pwd = masterPwd.value;
        if (!pwd) throw new Error("Enter your master password");
        await sls.unlock(pwd);
        setMode("master");
        setLocked(false);
        showAlert("success", "Unlocked");
        log("unlock ✓");
      } catch (err) {
        showAlert("danger", `unlock: ${err?.message ?? err}`);
        log(`unlock ✗ ${err?.message ?? err}`);
      }
    });

    btnLock.addEventListener("click", () => {
      sls.lock();
      setLocked(true);
      showAlert("warning", "Locked (device mode may auto-unlock on next read)");
      log("lock ✓");
    });

    btnRotateMaster.addEventListener("click", async () => {
      try {
        const oldP = oldPwd.value; const newP = newPwd.value;
        if (!oldP || !newP) throw new Error("Provide old and new passwords");
        await sls.rotateMasterPassword(oldP, newP);
        setMode("master");
        setLocked(false);
        refreshStored();
        showAlert("success", "Master password rotated");
        log("rotateMasterPassword ✓");
      } catch (err) {
        showAlert("danger", `rotateMasterPassword: ${err?.message ?? err}`);
      }
    });

    btnRemoveMaster.addEventListener("click", async () => {
      try {
        await sls.removeMasterPassword();
        setMode("passwordless");
        setLocked(false);
        refreshStored();
        showAlert("success", "Removed master password (device mode)");
        log("removeMasterPassword ✓");
      } catch (err) {
        showAlert("danger", `removeMasterPassword: ${err?.message ?? err}`);
      }
    });

    btnRotateKeys.addEventListener("click", async () => {
      try {
        await sls.rotateKeys();
        setMode("passwordless");
        setLocked(false);
        refreshStored();
        showAlert("info", "DEK and device KEK rotated");
        log("rotateKeys ✓");
      } catch (err) {
        showAlert("warning", `rotateKeys: ${err?.message ?? err}`);
      }
    });

    btnClearAll.addEventListener("click", async () => {
      await sls.clear();
      setMode("passwordless");
      setLocked(false);
      refreshStored();
      plainOut.textContent = "(empty)";
      showAlert("danger", "All data cleared and reinitialized");
      log("clear ✓");
    });

    btnExport.addEventListener("click", async () => {
      try {
        const pwd = exportPwd.value.trim();
        const json = await (pwd ? sls.exportData(pwd) : sls.exportData());
        exportOut.value = json;
        showAlert("success", "Exported to text area");
        log("exportData ✓");
      } catch (err) {
        showAlert("danger", `exportData: ${err?.message ?? err}`);
      }
    });

    btnDownload.addEventListener("click", () => {
      try {
        const blob = new Blob([exportOut.value || ""], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "sls-export.json";
        a.click();
        URL.revokeObjectURL(a.href);
      } catch { /* noop */ }
    });

    btnImport.addEventListener("click", async () => {
      try {
        const json = importIn.value.trim();
        if (!json) throw new Error("Paste export JSON first");
        const pwd = importPwd.value.trim() || undefined;
        await sls.importData(json, pwd);
        // Update best-effort mode hint based on presence of password
        setMode(pwd ? "passwordless" : "master");
        setLocked(false);
        refreshStored();
        showAlert("success", "Imported successfully");
        log("importData ✓");
      } catch (err) {
        showAlert("danger", `importData: ${err?.message ?? err}`);
      }
    });

    btnLoadFile.addEventListener("click", () => fileOpen.click());
    fileOpen.addEventListener("change", async () => {
      const file = fileOpen.files?.[0];
      if (!file) return;
      const text = await file.text();
      importIn.value = text;
      showAlert("secondary", `Loaded ${file.name}`);
    });

    // --- boot ---
    (async function boot() {
      setMode("passwordless"); // default view; will update as user changes mode
      await detectLockState();
      refreshStored();
      log("Demo booted");
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
